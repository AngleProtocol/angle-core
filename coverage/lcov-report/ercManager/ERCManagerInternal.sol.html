<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for ercManager/ERCManagerInternal.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">ercManager/</a> ERCManagerInternal.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>34/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>8/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>34/34</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">133×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">30×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: COMING SOON
&nbsp;
pragma solidity 0.8.2;
&nbsp;
import "./ERCManagerStorage.sol";
&nbsp;
/// @title ERCManagerInternal
/// @author Angle Core Team
/// @notice This contract corresponds to a collateral pool of the protocol for a stablecoin,
/// it manages a single ERC20 token
/// @dev This file contains all the internal functions
contract ERCManagerInternal is ERCManagerStorage, AccessControlUpgradeable {
    using SafeERC20 for IERC20;
&nbsp;
    // Roles need to be defined here because there are some internal access control functions
    // in the `ERCManagerInternal` file
    bytes32 public constant STABLEMASTER_ROLE = keccak256("STABLEMASTER_ROLE");
    bytes32 public constant GOVERNOR_ROLE = keccak256("GOVERNOR_ROLE");
    bytes32 public constant GUARDIAN_ROLE = keccak256("GUARDIAN_ROLE");
    bytes32 public constant KEEPER_ROLE = keccak256("KEEPER_ROLE");
    bytes32 public constant STRATEGY_ROLE = keccak256("STRATEGY_ROLE");
&nbsp;
    // ======================= Access Control and Governance =======================
&nbsp;
    /// @notice Adds a new guardian address and echoes the change to the contracts
    /// that interact with this collateral manager
    /// @param _guardian New guardian address
    function _addGuardian(address _guardian) internal {
        // Granting the new role
        // Access control for this contract
        grantRole(GUARDIAN_ROLE, _guardian);
        // Propagating the new role in other contract
        sanToken.grantRole(GUARDIAN_ROLE, _guardian);
        perpetualManager.grantRole(GUARDIAN_ROLE, _guardian);
        keeper.grantRole(GUARDIAN_ROLE, _guardian);
        for (uint256 i = 0; i &lt; strategyList.length; i++) {
            IStrategy(strategyList[i]).addGuardian(_guardian);
        }
    }
&nbsp;
    /// @notice Revokes the guardian role and propagates the change to other contracts
    /// @param guardian Old guardian address to revoke
    function _revokeGuardian(address guardian) internal {
        revokeRole(GUARDIAN_ROLE, guardian);
        sanToken.revokeRole(GUARDIAN_ROLE, guardian);
        perpetualManager.revokeRole(GUARDIAN_ROLE, guardian);
        keeper.revokeRole(GUARDIAN_ROLE, guardian);
        for (uint256 i = 0; i &lt; strategyList.length; i++) {
            IStrategy(strategyList[i]).revokeGuardian(guardian);
        }
    }
&nbsp;
    /// @notice Updates the token approval amount to a contract
    /// @param affectedContract Contract for which the token approval amount needs to change
    /// @param newAmount New approval amount
    /// @dev The way we use this contract is by setting approval amounts of either zero or 2**256-1
    function _changeTokenApprovalAmount(address affectedContract, uint256 newAmount) internal {
        token.approve(affectedContract, newAmount);
    }
&nbsp;
    // ============================= Yield Farming =================================
&nbsp;
    /// @notice Internal version of `updateStrategyDebtRatio`
    /// @dev Updates the debt ratio for a strategy
    function _updateStrategyDebtRatio(address strategy, uint256 _debtRatio) internal {
        StrategyParams storage params = strategies[strategy];
        require(params.lastReport != 0, "ERCManager::updateStrategyDebtRatio: invalid strategy");
        debtRatio = debtRatio + _debtRatio - params.debtRatio;
        require(debtRatio &lt;= BASE, "ERCManager::updateStrategyDebtRatio: debt ratio above one");
        params.debtRatio = _debtRatio;
        emit StrategyAdded(strategy, debtRatio);
    }
&nbsp;
    // ============================ Utils ==========================================
&nbsp;
    /// @notice Returns the manager's reserve of collateral (not including what has been lent)
    function _getBalance() internal view returns (uint256) {
        return token.balanceOf(address(this));
    }
&nbsp;
    /// @notice Returns the amount of assets owned by the manager
    /// @dev This sums the current balance of the contract to what has been given to strategies
    function _getTotalAsset() internal view returns (uint256) {
        return _getBalance() + totalDebt;
    }
&nbsp;
    /// @notice Computes the incentive for the keeper as a function of the fees initially taken to the HA
    /// and the margin ratio of the corresponding perpetual
    /// @param ratio Ratio between what's covered by the perpetual and the gap between what's covered
    /// and what's really to cover
    /// @param originalFees Amount of fees paid by the perpetual owner at creation
    /// @return keeperFeesCapped The amount of rewards going to the keeper
    /// @dev This internal function is computed each time fees need to be distributed to keepers intervening
    /// for HAs
    function _computeKeeperHAFees(uint256 ratio, uint256 originalFees) internal view returns (uint256) {
        uint256 rateFeeHA;
        if (ratio == 0) {
            // This corresponds to the case of a perpetual liquidation or of a perpetual being cashed because
            // of a too high leverage
            rateFeeHA = keeperFeesRatio;
        } else {
            // This corresponds to the case of a perpetual being cashed out because too much is covered by HAs
            rateFeeHA = _piecewiseLinear(ratio, xKeeperFeesCashOut, yKeeperFeesCashOut);
        }
        // Checking if the rewards do not exceed the maximum rewards amount that can be given to keepers
        uint256 keeperFees = (originalFees * rateFeeHA) / BASE;
        uint256 keeperFeesCapped = keeperFees &lt; keeperFeesCap ? keeperFees : keeperFeesCap;
        return keeperFeesCapped;
    }
&nbsp;
    /// @notice Allows to transfer collateral to an address while handling the case where there are
    /// not enough reserves
    /// @param owner Address of the receiver
    /// @param amount The amount of collateral sent
    /// @dev If there is not enough collateral in balance (this can happen when money has been lent),
    /// then the owner is reimbursed by receiving the delta in sanTokens at the correct value
    function _secureTransfer(address owner, uint256 amount) internal {
        uint256 curBalance = _getBalance();
        if (curBalance &gt;= amount) {
            // Case where there is enough in reserves to reimburse the person
            token.safeTransfer(owner, amount);
        } else {
            // When there is not enough to reimburse the entire amount, the protocol will reimburse
            // what it can using its reserves and the rest will be paid in sanTokens at the current
            // exchange rate
            uint256 amountLeft = amount - curBalance;
            token.safeTransfer(owner, curBalance);
            stableMaster.notifyDeposit(amountLeft, owner);
        }
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jul 14 2021 10:59:30 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
