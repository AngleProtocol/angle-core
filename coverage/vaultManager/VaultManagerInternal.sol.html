<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for vaultManager/VaultManagerInternal.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">vaultManager/</a> VaultManagerInternal.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">99.28% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>138/139</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.59% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>50/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>27/27</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.53% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>134/136</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">90×</span>
<span class="cline-any cline-yes">90×</span>
<span class="cline-any cline-yes">90×</span>
<span class="cline-any cline-yes">90×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">90×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">117×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">57×</span>
<span class="cline-any cline-yes">57×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">57×</span>
<span class="cline-any cline-yes">57×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">57×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">190×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">183×</span>
<span class="cline-any cline-yes">87×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">89×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-yes">79×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">150×</span>
<span class="cline-any cline-yes">150×</span>
<span class="cline-any cline-yes">149×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">102×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">69×</span>
<span class="cline-any cline-yes">63×</span>
<span class="cline-any cline-yes">63×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">48×</span>
<span class="cline-any cline-yes">48×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">48×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: COMING SOON
&nbsp;
pragma solidity 0.8.2;
&nbsp;
import "./VaultManagerStorage.sol";
&nbsp;
/// @title VaultManagerInternal
/// @author Angle Core Team
/// @notice VaultManager is the contract handling all the Hedging Agents cashOutAmounts and vaults
/// @dev There is one vaultManager contract per pair stablecoin/collateral in the protocol
/// @dev This file contains all the internal functions of the vaultManager contract
contract VaultManagerInternal is VaultManagerStorage {
    using Address for address;
    using SafeERC20 for IERC20;
&nbsp;
    // ========================= HA Vaults Functions ==============================
&nbsp;
    /// @notice Liquidates a vault
    /// @param vaultID ID of the vault being liquidated
    /// @dev This function is only called once required checks have been done
    function _liquidateVault(uint256 vaultID) internal {
        Vault memory vault = vaultData[vaultID];
&nbsp;
        // Handling the staking logic
        // Reward should always be updated before the totalCAmount
        // Rewards are distributed to the vault which is liquidated
        _getReward(vaultID);
        delete vaultRewardPerTokenPaid[vaultID];
&nbsp;
        // Updating totalCAmount to represent the fact that less collateral is now insured
        totalCAmount -= vault.committedAmount;
        emit TotalCAmountUpdate(totalCAmount);
&nbsp;
        // Burning the vault
        _burn(vaultID);
&nbsp;
        // Transfering the amount to stocks users to represent the fact that this amount now belongs to the protocol
        // The int conversion cannot normally overflow here as it can only come
        // from the update or creation function where the condition is already checked
        stableMaster.updateStockUsers(int256(vault.cashOutAmount));
    }
&nbsp;
    /// @notice Cashes out a vault
    /// @param vaultID ID of the vault
    /// @param cashOutAmount The current cashOutAmount
    /// @dev Every time this function is called the cashOutAmount has previously been computed
    function _cashOutVault(uint256 vaultID, uint256 cashOutAmount) internal {
        Vault memory vault = vaultData[vaultID];
        if (cashOutAmount == 0) {
            // If the vault needs to be liquidated, logic is changed
            _liquidateVault(vaultID);
        } else {
            // Checking if the vault can be cashed out yet
            require(
                vault.creationBlock + secureBlocks &lt;= block.timestamp,
                "VaultManager::_cashOutVault: vault cannot be cashed out yet"
            );
            // Checking for overflows because some quantities will be converted to int
            // cashOutAmount has been checked for overflow when it got updated in _update
            // and at vault creation
            <span class="missing-if-branch" title="else path not taken" >E</span>require(int256(cashOutAmount) &gt;= 0, "VaultManager::_cashOutVault: overflow");
&nbsp;
            // This is as a staking withdraw: we call _updateRewards before other updates are made
            _getReward(vaultID);
            delete vaultRewardPerTokenPaid[vaultID];
&nbsp;
            // Updating totalCAmount to represent the fact that less money is insured
            totalCAmount -= vault.committedAmount;
            emit TotalCAmountUpdate(totalCAmount);
&nbsp;
            _burn(vaultID);
&nbsp;
            // Updating stockUsers before the cash out
            stableMaster.updateStockUsers(int256(vault.cashOutAmount) - int256(cashOutAmount));
        }
    }
&nbsp;
    /// @notice Updates the vault associated to vaultID
    /// @param vaultID ID of the vault
    /// @param amount Amount of the transaction
    /// @param withdraw Whether the owner or the approved person wishes to withdraw or add collateral
    /// @param curCashOutAmount Current cashOutAmount of the vault
    /// @param fees Fees to add to the liquidation reward
    /// @param rate Rate of the oracle
    /// @dev This function is typically called when a HA adds or removes collateral from an owned vault
    /// @dev The rate fed to this function will most of the time be a high value (the highest between Uniswap and Chainlink)
    /// @dev The cashOutAmount fed to this function will have been computed using a low oracle value
    function _update(
        uint256 vaultID,
        uint256 amount,
        bool withdraw,
        uint256 curCashOutAmount,
        uint256 fees,
        uint256 rate
    ) internal {
        Vault storage vault = vaultData[vaultID];
        // Computing the vault's new cash out amount, it is simply the current's cashOutAmount updated by the amount
        uint256 newCashOutAmount;
        if (withdraw) {
            // It has been checked in removeFromVault that amount was not bigger than cashOutAmount
            newCashOutAmount = curCashOutAmount - amount;
        } else {
            newCashOutAmount = curCashOutAmount + amount;
        }
        // Checking the require before any state update to save gas
        <span class="missing-if-branch" title="else path not taken" >E</span>require(int256(newCashOutAmount) &gt;= 0, "VaultManager::_update: overflow");
        // Updating the collateral from users to cover by the capital gain or loss made by HA
        // The cashOutAmount by HAs is always checked for overflows when casting to int whenever it is updated (see above)
        // no need to double check it here
        <span class="missing-if-branch" title="else path not taken" >E</span>require(int256(curCashOutAmount) &gt;= 0, "VaultManager::_update: overflow");
&nbsp;
        int256 oldCashOutAmount = int256(vault.cashOutAmount);
&nbsp;
        // Updating the parameters of the vault
        vault.initialRate = rate;
        // The new cash out amount by the vault is now the cashOutAmount of the vault
        vault.cashOutAmount = newCashOutAmount;
        vault.creationBlock = block.timestamp;
        vault.fees += fees;
        emit VaultUpdate(vaultID, rate, newCashOutAmount, vault.committedAmount, vault.fees);
&nbsp;
        stableMaster.updateStockUsers(oldCashOutAmount - int256(curCashOutAmount));
    }
&nbsp;
    // ========================= Internal view ==============================
&nbsp;
    /// @notice Computes the amount that is covered by HAs and the amount that they are allowed to cover
    /// @param amount Amount to add or withdraw to the current total amount committed
    /// @param withdraw Whether we should withdraw (or add) the amount from totalCAmount
    /// @param rate Value of the oracle, used to compute the maximum amount to cover
    /// @return newCoveredAmount Amount of collateral insured by HAs if amount more is covered
    /// @return maxCoveredAmount Maximum amount of collateral that can be insured
    function _testMaxCAmount(
        uint256 amount,
        uint256 withdraw,
        uint256 rate
    ) internal view returns (uint256 newCoveredAmount, uint256 maxCoveredAmount) {
        // Fetching info from the stableMaster
        int256 signedStockUsers;
        uint256 maxTotalCoveredAmount;
        uint256 agTokensMinted;
        (signedStockUsers, maxTotalCoveredAmount, agTokensMinted) = stableMaster.giveVaultManagerInfo();
&nbsp;
        // Case where there are too many HAs and no new HAs can come in
        if (signedStockUsers &lt;= 0) return (1, 0);
&nbsp;
        // Computing the bound on leverage and testing if amount can be added to totalCAmount
        // Everything needs to be set in the same base
        // no need to test if totalCAmount &gt; amount it is always the case
        if (withdraw &gt; 0) newCoveredAmount = ((totalCAmount - amount) * BASE) / collatBase;
        else newCoveredAmount = ((totalCAmount + amount) * BASE) / collatBase;
&nbsp;
        uint256 stockUsers = (uint256(signedStockUsers) * BASE) / collatBase;
        // We multiply by base because rate is in base
        uint256 stablecoinsInCol = (agTokensMinted * BASE) / rate;
&nbsp;
        // To compute the maximum covered amount, we take the minimum between the minted assets and stockUsers
        // To gain precision, instead of using the formula: maxCoveredAmount = (stockUsers * maxTotalCoveredAmount) / BASE;
        // We do:
        if (stablecoinsInCol &gt;= stockUsers)
            maxCoveredAmount = (uint256(signedStockUsers) * maxTotalCoveredAmount) / collatBase;
            // Same here, instead of using: maxCoveredAmount = (stablecoinsInCol * maxTotalCoveredAmount) / BASE; we do:
        else maxCoveredAmount = (agTokensMinted * maxTotalCoveredAmount) / rate;
        // Both of the returned amounts are in BASE
    }
&nbsp;
    /// @notice Gets the current cashOutAmount of a vault
    /// @param vaultID ID of the concerned vault
    /// @param rate Value of the oracle
    /// @return newCashOutAmount New cashOutAmount of the vault
    /// @return reachMaintenanceMargin Whether the position of the vault is now too small
    /// compared with its initial position
    /// @dev Refer to the whitepaper for the formulas of the cashOutAmount
    /// @dev maintenanceMargin is standard in centralized platforms offering perpetual futures
    function _getCashOutAmount(uint256 vaultID, uint256 rate)
        internal
        view
        returns (uint256 newCashOutAmount, uint256 reachMaintenanceMargin)
    {
        Vault memory vault = vaultData[vaultID];
&nbsp;
        // All these computations are made just because we are working with uint and not int
        // so we cannot do x-y if x&lt;y!
        uint256 newCommit = (vault.committedAmount * vault.initialRate) / rate;
        // Checks if a liquidation is needed
        reachMaintenanceMargin = 0;
        if (newCommit &gt;= vault.committedAmount + vault.cashOutAmount) newCashOutAmount = 0;
        else {
            newCashOutAmount = vault.committedAmount + vault.cashOutAmount - newCommit;
            if (newCashOutAmount &lt;= (vault.cashOutAmount * maintenanceMargin) / BASE) reachMaintenanceMargin = 1;
        }
    }
&nbsp;
    /// @notice Calls the oracle to read both Chainlink and Uniswap rates
    /// @return The lowest oracle value (between Chainlink and Uniswap) is the first outputted value
    /// @return The highest oracle value is the second output
    /// @dev If the oracle only involves a single oracle fees (like just Chainlink for USD-EUR),
    /// the same value will be returned twice
    function _getOraclePrice() internal view returns (uint256, uint256) {
        return oracle.readAll();
    }
&nbsp;
    /// @notice Gets necessary info to force the cash out of a vault
    /// @param vaultID ID of the vault to cash out
    /// @param rateDown Low oracle value (the lowest between Chainlink and Uniswap)
    /// @param rateUp High oracle value (the highest between Chainlink and Uniswap)
    /// @return canbeCashedOut Whether the vault can be cashed out by someone that is not the owner of the vault
    /// @return cashOutAmount Current cash out amount of the amount
    /// @return ratioCoverVsTooMuchCovered Ratio between the covered amount by the vault and the protocol over coverage
    /// @return netCashOutAmount Cash out amount of the vault net of exit fees
    /// @return fees Fees initially paid at vault creation
    function _getForcedExitInfo(
        uint256 vaultID,
        uint256 rateDown,
        uint256 rateUp
    )
        internal
        view
        returns (
            uint256,
            uint256,
            uint256,
            uint256,
            uint256
        )
    {
        // First checking if the vault should not be liquidated
        (uint256 cashOutAmount, uint256 reachMaintenanceMargin) = _getCashOutAmount(vaultID, rateDown);
        uint256 fees = vaultData[vaultID].fees;
        uint256 committedAmount = vaultData[vaultID].committedAmount;
        if (reachMaintenanceMargin == 1 || cashOutAmount == 0) {
            // In the tryCashOutVault this will result in the vault being liquidated and the keeper
            // being paid the same amount of fees as what would have been paid if the vault had been liquidated
            return (1, 0, 0, 0, fees);
        }
        // Now checking if too much collateral is not covered by HAs
        (uint256 currentCAmount, uint256 maxCAmount) = _testMaxCAmount(0, 0, rateUp);
&nbsp;
        // If too much collateral is covered then the vault can be cashed out
        uint256 canBeCashedOut = currentCAmount &gt; maxCAmount ? 1 : 0;
&nbsp;
        uint256 ratioCoverVsTooMuchCovered = 0;
        // Quantity used to compute exit fees for the HA
        uint256 margin = 0;
        if (canBeCashedOut &gt; 0) {
            // If too much is covered, computing by how much too much is covered
            // The following quantity is the ratio between the amount covered by the HA
            // (expressed in base and not in collatBase) divided by the difference between what's covered
            // and what should in place be covered by HAs
            // It is used to compute the amount of fees that will be distributed to the keeper cashing out the vault
            // The clean formula is committedAmount * BASE / collatBase * BASE / (currentCAmount - maxCAmount)
            ratioCoverVsTooMuchCovered = (committedAmount * BASE**2) / ((currentCAmount - maxCAmount) * collatBase);
        } else {
            // Checking if the vault can be cashed out because the leverage became too high
            canBeCashedOut = ((committedAmount * BASE) &gt;= cashOutLeverage * cashOutAmount) ? 1 : 0;
            // The following helps to compute the net amount returned to the vault owner
            // The margin should take into account what will be the covered amount after the vault is cashed out
            // It is important to pay attention to the base in which the committed amount is expressed
            margin = ((maxCAmount + (committedAmount * BASE) / collatBase - currentCAmount) * BASE) / maxCAmount;
        }
        uint256 netCashOutAmount = _computeFeeHAWithdraw(cashOutAmount, margin);
&nbsp;
        return (canBeCashedOut, cashOutAmount, ratioCoverVsTooMuchCovered, netCashOutAmount, fees);
    }
&nbsp;
    // ========================= Fee Computation ==============================
&nbsp;
    /// @notice Gets the value of the fees and the net amount corrected from the fees in case of
    /// a deposit or a withdraw of collateral from a HA vault
    /// @param amount Amount to deposit or withdraw from the vault
    /// @param oracleRate Value of the oracle
    /// @param entry Checker to see if the transaction is a deposit or a withdraw
    /// @return netAmount Amount that will be either written in the vault as the cashOutAmount or given back to the HA
    /// @return fees Fees induced by this transaction
    function _getNetAmountAndFeesUpdate(
        uint256 amount,
        uint256 oracleRate,
        uint256 entry
    ) internal view returns (uint256 netAmount, uint256 fees) {
        uint256 margin = _computeCoverageMargin(0, 0, oracleRate);
        // Computing the amount brought to add in the vault by deducing fees
        if (entry &gt; 0) {
            netAmount = _computeFeeHADeposit(amount, margin);
        } else {
            netAmount = _computeFeeHAWithdraw(amount, margin);
        }
        fees = amount - netAmount;
    }
&nbsp;
    /// @notice Gets the value of the fees and the net amount corrected from the fees in case of vault creation
    ///
    /// @param committedAmount commited amount in the vault
    /// @param broughtAmount the brought amount in the vault
    /// @param oracleRate Value of the oracle
    /// @return netBroughtAmount Amount that will be written in the vault as the cashOutAmount
    /// @return fees Fees induced by this transaction
    function _getNetAmountAndFeesCreation(
        uint256 broughtAmount,
        uint256 committedAmount,
        uint256 oracleRate
    ) internal view returns (uint256 netBroughtAmount, uint256 fees) {
        // Checking if the HA has the right to create a vault with such amount
        // If too much is already covered by HAs, the HA will not be able to create a vault
        (uint256 newCAmount, uint256 maxCAmount) = _testMaxCAmount(committedAmount, 0, oracleRate);
        require(
            newCAmount &lt;= maxCAmount,
            "VaultManagerInternal::_getNetAmountAndFeesCreation: already too much collateral covered by HAs"
        );
&nbsp;
        // Computing entry fees: they depend on how much is already covered by HAs compared with what's to cover
        // Getting the difference between the maximum amount to cover and the current amount covered
        uint256 marginToMaxCAMount = ((maxCAmount - newCAmount) * BASE) / maxCAmount;
&nbsp;
        // Computing the net amount brought by the HAs to store in the vault
        // It consists simply in deducing fees
        netBroughtAmount = _computeFeeHADeposit(broughtAmount, marginToMaxCAMount);
        fees = broughtAmount - netBroughtAmount;
    }
&nbsp;
    /// @notice Gets the value of the margin that is the ratio between the gap of collateral to cover and the total
    /// amount to cover
    /// @param committedAmount Amount to add or withdraw to the current total amount committed
    /// @param withdraw Whether we should withdraw (or add) the amount from totalCAmount
    /// @param oracleRate Value of the oracle
    /// @return margin Ratio between the gap of collateral to cover and the total amount to cover
    function _computeCoverageMargin(
        uint256 committedAmount,
        uint256 withdraw,
        uint256 oracleRate
    ) internal view returns (uint256 margin) {
        (uint256 currentCAmount, uint256 maxCAmount) = _testMaxCAmount(committedAmount, withdraw, oracleRate);
        if (currentCAmount &lt; maxCAmount) margin = ((maxCAmount - currentCAmount) * BASE) / maxCAmount;
        else margin = 0;
    }
&nbsp;
    /// @notice Helps to compute the net amount to add to a HA vault by deducing the fees from a given amount
    /// @param amount Raw value we need to reimburse
    /// @param gapMaxCAmount Utilization ratio (margin between the insured stocks and the stable seekers collateral to insure)
    /// @dev amount should be expressed in collat base and gapMaxCAmount should be in base
    /// @dev The result is expressed in collat base
    function _computeFeeHADeposit(uint256 amount, uint256 gapMaxCAmount) internal view returns (uint256) {
        uint256 haFeesDeposit = _piecewiseLinear(gapMaxCAmount, xHAFeesDeposit, yHAFeesDeposit);
        haFeesDeposit = (haFeesDeposit * haFeesDepositKeeper) / BASE;
&nbsp;
        return (amount * (BASE - haFeesDeposit)) / BASE;
    }
&nbsp;
    /// @notice Helps to compute the net amount to withdraw from a HA vault by deducing exit fees
    /// @param amount Raw value we need to reimburse
    /// @param gapMaxCAmount Utilization ratio (margin between the insure stocks and the stable seekers stocks)
    /// @dev amount should be expressed in collat base and gapMaxCAmount should be in BASE
    /// @dev The result is expressed in collat base
    function _computeFeeHAWithdraw(uint256 amount, uint256 gapMaxCAmount) internal view returns (uint256) {
        uint256 haFeesWithdraw = _piecewiseLinear(gapMaxCAmount, xHAFeesWithdraw, yHAFeesWithdraw);
        haFeesWithdraw = (haFeesWithdraw * haFeesWithdrawKeeper) / BASE;
&nbsp;
        return (amount * (BASE - haFeesWithdraw)) / BASE;
    }
&nbsp;
    // ========================= Reward Distribution ==============================
&nbsp;
    /// @notice View function to query the last timestamp a reward was distributed
    /// @return Current timestamp if a reward is being distributed or the last timestep
    function _lastTimeRewardApplicable() internal view returns (uint256) {
        if (block.timestamp &lt;= periodFinish) {
            return block.timestamp;
        }
        return periodFinish;
    }
&nbsp;
    function _rewardPerToken() internal view returns (uint256) {
        if (totalCAmount == 0) {
            return rewardPerTokenStored;
        }
        return
            rewardPerTokenStored + ((_lastTimeRewardApplicable() - lastUpdateTime) * rewardRate * 1e18) / totalCAmount;
    }
&nbsp;
    /// @notice Allows a vault owner to withdraw rewards
    /// @param vaultID ID of the vault which accumulated tokens
    /// @dev Internal version of the getReward function
    function _getReward(uint256 vaultID) internal {
        _updateReward(vaultID);
        uint256 reward = rewards[vaultID];
        if (reward &gt; 0) {
            rewards[vaultID] = 0;
            address owner = owners[vaultID];
            // Attention here, there may be reentrancy attacks because of the following call
            // to an external contract done before other things are modified, yet since the rewardToken
            // is mostly going to be a contract controlled by governance (namely the Mur token), then
            // there is no point in putting an expensive nonReentrant modifier in the functions in ERCManagerFront
            // that allow indirect interactions with _updateReward. If new rewardTokens are set, we could think about
            // upgrading the ERCManagerFront contract
            rewardToken.safeTransfer(owner, reward);
            emit RewardPaid(owner, reward);
        }
    }
&nbsp;
    /// @notice Allows to check the amount of gov tokens earned by a vault
    /// @param vaultID ID of the vault which accumulated tokens
    /// @return Amount of gov tokens earned by the vault
    function _earned(uint256 vaultID) internal view returns (uint256) {
        return
            (vaultData[vaultID].committedAmount * (_rewardPerToken() - vaultRewardPerTokenPaid[vaultID])) /
            1e18 +
            rewards[vaultID];
    }
&nbsp;
    /// @notice Updates the amount of gov tokens earned by a vault
    /// @param vaultID of the vault which earns tokens
    /// @dev When this function is called in the code, it has already been checked that the vaultID
    /// exists
    function _updateReward(uint256 vaultID) internal {
        rewardPerTokenStored = _rewardPerToken();
        lastUpdateTime = _lastTimeRewardApplicable();
        // No need to check if the vaultID exists here, it has already been checked
        // in the code before when this internal function is called
        rewards[vaultID] = _earned(vaultID);
        vaultRewardPerTokenPaid[vaultID] = rewardPerTokenStored;
    }
&nbsp;
    // ========================= ERC721 Logic ==============================
&nbsp;
    /// @notice Gets the owner of a vault
    /// @param vaultID ID of the concerned vault
    /// @return Owner of the vault
    function _ownerOf(uint256 vaultID) internal view returns (address) {
        address owner = owners[vaultID];
        require(owner != address(0), "VaultManager::ownerOf: owner query for nonexistent vault");
        return owner;
    }
&nbsp;
    /// @notice Gets the addresses approved for a vault
    /// @param vaultID ID of the concerned vault
    /// @return Address approved for this vault
    function _getApproved(uint256 vaultID) internal view returns (address) {
        require(_exists(vaultID), "VaultManager::getApproved: approved query for nonexistent vault");
        return vaultApprovals[vaultID];
    }
&nbsp;
    /// @notice Safely transfers `vaultId` token from `from` to `to`, checking first that contract recipients
    /// are aware of the ERC721 protocol to prevent tokens from being forever locked
    /// @param vaultID ID of the concerned vault
    /// @param _data Additional data, it has no specified format and it is sent in call to `to`
    /// @dev This internal function is equivalent to {safeTransferFrom}, and can be used to e.g.
    /// implement alternative mechanisms to perform token transfer, such as signature-based
    /// @dev Requirements:
    ///     - `from` cannot be the zero address.
    ///     - `to` cannot be the zero address.
    ///     - `vaultId` token must exist and be owned by `from`.
    ///     - If `to` refers to a smart contract, it must implement {IERC721Receiver-onERC721Received}, which is called upon a safe transfer.
    function _safeTransfer(
        address from,
        address to,
        uint256 vaultID,
        bytes memory _data
    ) internal virtual {
        _transfer(from, to, vaultID);
        require(
            _checkOnERC721Received(from, to, vaultID, _data),
            "VaultManager::_safeTransfer: transfer to non ERC721Receiver implementer"
        );
    }
&nbsp;
    /// @notice Returns whether `vaultID` exists
    /// @dev Tokens can be managed by their owner or approved accounts via {approve} or {setApprovalForAll}
    /// @dev Tokens start existing when they are minted (`_mint`),
    /// and stop existing when they are burned (`_burn`)
    function _exists(uint256 vaultID) internal view virtual returns (bool) {
        return owners[vaultID] != address(0);
    }
&nbsp;
    /// @notice Returns whether `spender` is allowed to manage `vaultID`
    /// @dev `vaultID` must exist
    function _isApprovedOrOwner(address spender, uint256 vaultID) internal view virtual returns (bool) {
        require(_exists(vaultID), "VaultManager::_isApprovedOrOwner: operator query for nonexistent vault");
        address owner = _ownerOf(vaultID);
        return (spender == owner || _getApproved(vaultID) == spender || operatorApprovals[owner][spender]);
    }
&nbsp;
    /// @notice Mints `vaultID` and transfers it to `to`
    /// @dev Usage of this method is discouraged, use {_safeMint} whenever possible
    /// @dev `vaultID` must not exist and `to` cannot be the zero address
    /// @dev Emits a {Transfer} event
    function _mint(address to, uint256 vaultID) internal virtual {
        balances[to] += 1;
        owners[vaultID] = to;
&nbsp;
        emit Transfer(address(0), to, vaultID);
    }
&nbsp;
    /// @notice Destroys `vaultID`
    /// @dev `vaultID` must exist
    /// @dev Emits a {Transfer} event
    function _burn(uint256 vaultID) internal virtual {
        address owner = _ownerOf(vaultID);
&nbsp;
        // Clear approvals
        _approve(address(0), vaultID);
&nbsp;
        balances[owner] -= 1;
        delete owners[vaultID];
        delete vaultData[vaultID];
&nbsp;
        emit Transfer(owner, address(0), vaultID);
    }
&nbsp;
    /// @notice Transfers `vaultId` from `from` to `to` as opposed to {transferFrom},
    /// this imposes no restrictions on msg.sender
    /// @dev `to` cannot be the zero address and `vaultId` token must be owned by `from`
    /// @dev Emits a {Transfer} event
    function _transfer(
        address from,
        address to,
        uint256 vaultID
    ) internal virtual {
        require(_ownerOf(vaultID) == from, "VaultManager::_transfer: transfer of vault that is not own");
        require(to != address(0), "VaultManager::_transfer: transfer to the zero address");
&nbsp;
        // Clear approvals from the previous owner
        _approve(address(0), vaultID);
&nbsp;
        balances[from] -= 1;
        balances[to] += 1;
        owners[vaultID] = to;
&nbsp;
        emit Transfer(from, to, vaultID);
    }
&nbsp;
    /// @notice Approves `to` to operate on `vaultId`
    /// @dev Emits a {Approval} event
    function _approve(address to, uint256 vaultId) internal virtual {
        vaultApprovals[vaultId] = to;
        emit Approval(_ownerOf(vaultId), to, vaultId);
    }
&nbsp;
    /// @notice Internal function to invoke {IERC721Receiver-onERC721Received} on a target address
    /// The call is not executed if the target address is not a contract
    /// @param from Address representing the previous owner of the given token ID
    /// @param to Target address that will receive the tokens
    /// @param vaultID uint256 ID of the token to be transferred
    /// @param _data Bytes optional data to send along with the call
    /// @return Bool whether the call correctly returned the expected magic value
    function _checkOnERC721Received(
        address from,
        address to,
        uint256 vaultID,
        bytes memory _data
    ) private returns (bool) {
        if (to.isContract()) {
            try IERC721ReceiverUpgradeable(to).onERC721Received(msg.sender, from, vaultID, _data) returns (
                bytes4 retval
            ) {
<span class="cstat-no" title="statement not covered" >                return retval == IERC721ReceiverUpgradeable(to).onERC721Received.selector;</span>
            } catch (bytes memory reason) {
                <span class="missing-if-branch" title="else path not taken" >E</span>if (reason.length == 0) {
                    revert("VaultManager::_checkOnERC721Received: transfer to non ERC721Receiver implementer");
                } else {
                    // solhint-disable-next-line no-inline-assembly
                    assembly {
                        revert(add(32, reason), mload(reason))
                    }
                }
            }
        } else {
            return true;
        }
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jul 07 2021 11:55:10 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
