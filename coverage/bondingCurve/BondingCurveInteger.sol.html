<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for bondingCurve/BondingCurveInteger.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">bondingCurve/</a> BondingCurveInteger.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/63</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/66</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: UNLICENSED
&nbsp;
pragma solidity 0.8.2;
&nbsp;
import "./BondingCurveEvents.sol";
&nbsp;
/// @title BondingCurve
/// @author Angle Protocol
/// @notice Enables anyone to buy Gov tokens following a bonding curve using stablecoins of the protocol
contract BondingCurveInteger is IBondingCurve, BondingCurveEvents, AccessControl, Pausable {
    bytes32 public constant GOVERNOR_ROLE = keccak256("GOVERNOR_ROLE");
    bytes32 public constant GUARDIAN_ROLE = keccak256("GUARDIAN_ROLE");
&nbsp;
    /// @notice Base used to compute ratios and floating numbers
    uint256 public constant BASE = 1e18;
&nbsp;
    // ============================ References to contracts ===================================
&nbsp;
    /// @notice Interface for the token sold by this contract, most likely mur tokens
    IERC20 public soldToken;
&nbsp;
    /// @notice Address of the reference coin, the one other stablecoins are converted to
    /// @dev If the reference is not a stablecoin that can be used to buy tokens with this contract, this is set to 0
    /// The reference stablecoin may change, but it would imply a change in all oracles,
    /// so it's important to be wary when updating it
    address public referenceCoin = address(0);
&nbsp;
    // ============================ Parameters ===================================
&nbsp;
    /// @notice Start price at which the bonding curve will sell
    /// This price will be expressed in a reference (most likely USD)
    uint256 public startPrice;
&nbsp;
    /// @notice Power parameter for the bonding curve: the price is:
    /// startPrice/(1-tokensSoldInTx/tokensToSellInTotal)^power
    uint256 public power;
&nbsp;
    /// @notice Number of tokens to sell with this contract. It can be either increased or decreased
    uint256 public totalTokensToSell = 0;
&nbsp;
    /// @notice Number of tokens sold so far. It should be inferior to totalTokensToSell
    uint256 public tokensSold = 0;
&nbsp;
    /// @notice Map of stablecoins that can be used to buy along with the oracle contract to the reference stablecoin
    mapping(IAToken =&gt; IOracle) public allowedStablecoins;
&nbsp;
    // ============================ Modifier ===================================
&nbsp;
    /// @notice Checks if it's not a contract calling a function
    /// @dev Way to prevent flash loans
<span class="fstat-no" title="function not covered" >    modifier nonContract() {</span>
<span class="cstat-no" title="statement not covered" >        require(!Address.isContract(msg.sender), "BondingCurve::nonContract: caller is a contract")</span>;
        _;
    }
&nbsp;
    /// @notice Checks if the stablecoin is valid
<span class="fstat-no" title="function not covered" >    modifier isValid(IAToken token) {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            (address(allowedStablecoins[token]) != address(0)) ||
                (referenceCoin == address(token) &amp;&amp; referenceCoin != address(0)),
            "BondingCurve::isValid: stablecoin not accepted"
        );
        _;
    }
&nbsp;
    // ============================ Constructor ===================================
&nbsp;
    /// @notice Initializes the BondingCurve contract
    /// @param governorList List of the governor addresses of the protocol
    /// @param guardian Address of the guardian
    /// @param _startPrice Start price of the token, it converts an amount of reference stablecoins to an amount
    /// of sold token
    /// @param _soldToken Token that it will be possible to buy using this contract
    /// @param _power Parameter for the bonding curve
<span class="fstat-no" title="function not covered" >    constructor(</span>
        address[] memory governorList,
        address guardian,
        uint256 _startPrice,
        IERC20 _soldToken,
        uint256 _power
    ) {
        // Access control
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; governorList.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            _setupRole(GOVERNOR_ROLE, governorList[i])</span>;
<span class="cstat-no" title="statement not covered" >            _setupRole(GUARDIAN_ROLE, governorList[i])</span>;
        }
<span class="cstat-no" title="statement not covered" >        _setupRole(GUARDIAN_ROLE, guardian)</span>;
<span class="cstat-no" title="statement not covered" >        _setRoleAdmin(GOVERNOR_ROLE, GOVERNOR_ROLE)</span>;
<span class="cstat-no" title="statement not covered" >        _setRoleAdmin(GUARDIAN_ROLE, GOVERNOR_ROLE)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        startPrice = _startPrice</span>;
<span class="cstat-no" title="statement not covered" >        soldToken = _soldToken</span>;
        // Instead of storing the power, we store the power - 1 since the power is never actually
        // truly needed
<span class="cstat-no" title="statement not covered" >        power = _power</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit BondingCurveInit(startPrice, address(soldToken));</span>
    }
&nbsp;
    // ============================ Main Function ===================================
&nbsp;
    /// @notice Lets caller buy sold tokens against an allowed token
    /// @param _aToken Reference to the aToken used
    /// @param targetSoldTokenQuantity Target quantity of sold tokens to buy
<span class="fstat-no" title="function not covered" >    function buySoldToken(IAToken _aToken, uint256 targetSoldTokenQuantity)</span>
        external
        override
        nonContract
        whenNotPaused
        isValid(_aToken)
    {
        // Computing the number of reference stablecoins to burn to get the desired quantity
        // of sold tokens
<span class="cstat-no" title="statement not covered" >        uint256 amountToPayInReference = _computePriceFromQuantity(targetSoldTokenQuantity);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 amountToPayInAToken = 0;</span>
        // The validity of the stablecoin has already been checked
<span class="cstat-no" title="statement not covered" >        if (address(_aToken) == referenceCoin) {</span>
<span class="cstat-no" title="statement not covered" >            amountToPayInAToken = amountToPayInReference</span>;
        } else {
            // Converting a number of reference stablecoin to a number of desired stablecoin
            // using the oracle provided
<span class="cstat-no" title="statement not covered" >            IOracle oracle = allowedStablecoins[_aToken];</span>
<span class="cstat-no" title="statement not covered" >            uint256 oracleValue = oracle.readLower(1);</span>
<span class="cstat-no" title="statement not covered" >            amountToPayInAToken = (amountToPayInReference * BASE) / oracleValue</span>;
<span class="cstat-no" title="statement not covered" >            require(amountToPayInAToken &gt; 0, "BondingCurve::buySoldToken: oracle attack")</span>;
        }
&nbsp;
        // Burning the correct amount of aToken
<span class="cstat-no" title="statement not covered" >        _aToken.burnFromNoRedeem(msg.sender, amountToPayInAToken)</span>;
        // Transfering the sold tokens to the caller
<span class="cstat-no" title="statement not covered" >        soldToken.transfer(msg.sender, targetSoldTokenQuantity)</span>;
&nbsp;
        // Updating the internal variables
        // solhint-disable-next-line reentrancy
<span class="cstat-no" title="statement not covered" >        tokensSold += targetSoldTokenQuantity</span>;
<span class="cstat-no" title="statement not covered" >        emit TokenSale(targetSoldTokenQuantity, address(_aToken), amountToPayInAToken);</span>
    }
&nbsp;
    // ============================ View Functions ===============================
&nbsp;
    /// @notice Returns the current price of the token (expressed in reference)
<span class="fstat-no" title="function not covered" >    function getCurrentPrice() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        if (_getQuantityLeftToSell() == 0) {</span>
<span class="cstat-no" title="statement not covered" >            return 0;</span>
        }
<span class="cstat-no" title="statement not covered" >        uint256 value = (startPrice * (totalTokensToSell**power)) / ((totalTokensToSell - tokensSold)**power) / BASE;</span>
<span class="cstat-no" title="statement not covered" >        return value;</span>
    }
&nbsp;
    /// @notice Returns the quantity of governance tokens that are still to be sold
<span class="fstat-no" title="function not covered" >    function getQuantityLeftToSell() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return _getQuantityLeftToSell();</span>
    }
&nbsp;
    /// @notice Returns the amount to pay for the desired amount of MUR to buy
    /// @param targetQuantity Quantity of MUR tokens to buy
<span class="fstat-no" title="function not covered" >    function computePriceFromQuantity(uint256 targetQuantity) external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return _computePriceFromQuantity(targetQuantity);</span>
    }
&nbsp;
    // ============================ GOVERNANCE ===================================
&nbsp;
    // ========================== Governor Function ==============================
&nbsp;
    /// @notice Transfers tokens from the bonding curve to another address
    /// @param amountToRecover Amount of tokens to transfer
    /// @param to Destination address
<span class="fstat-no" title="function not covered" >    function recoverTokens(uint256 amountToRecover, address to) external onlyRole(GOVERNOR_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _changeTokensToSell(totalTokensToSell - amountToRecover)</span>;
        // No need to check the balance here
<span class="cstat-no" title="statement not covered" >        soldToken.transfer(to, amountToRecover)</span>;
    }
&nbsp;
    // ========================== Guardian Functions =============================
&nbsp;
    /// @notice Allows a new stablecoin
    /// @param _aToken Reference to the aToken
    /// @param _oracle Reference to the oracle that will be used to have the price of this stablecoin in reference
    /// @param _isReference Whether this stablecoin will be the reference for oracles
    /// @dev To set a new reference coin, the old reference must have been revoked before
    /// @dev Calling this function for a stablecoin that already exists will just change its oracle if the
    /// aToken was already reference, and also set a new reference if the coin was already existing
<span class="fstat-no" title="function not covered" >    function allowNewStablecoin(</span>
        IAToken _aToken,
        IOracle _oracle,
        uint256 _isReference
    ) external onlyRole(GUARDIAN_ROLE) {
<span class="cstat-no" title="statement not covered" >        require((_isReference == 0) || (_isReference == 1), "BondingCurve::allowNewStablecoin: incorrect reference")</span>;
<span class="cstat-no" title="statement not covered" >        require(address(_aToken) != address(0), "BondingCurve::allowNewStablecoin: incorrect address")</span>;
        // After that it is going to be impossible to change reference if the reference has not been revoked before
<span class="cstat-no" title="statement not covered" >        require(</span>
            (_isReference == 0) || (referenceCoin == address(0)),
            "BondingCurve::allowNewStablecoin: already a reference"
        );
<span class="cstat-no" title="statement not covered" >        require(</span>
            (_isReference == 1) || (address(_oracle) != address(0)),
            "BondingCurve::allowNewStablecoin: oracle required"
        );
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (_isReference == 1) {</span>
<span class="cstat-no" title="statement not covered" >            referenceCoin = address(_aToken)</span>;
        }
        // Oracle contract should be done with respect to reference
<span class="cstat-no" title="statement not covered" >        allowedStablecoins[_aToken] = _oracle</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit ModifiedStablecoin(address(_aToken), (_isReference == 1), address(_oracle));</span>
    }
&nbsp;
    /// @notice Changes the oracle associated to a stablecoin
    /// @param _aToken Reference to the aToken
    /// @param _oracle Reference to the oracle that will be used to have the price of this stablecoin in reference
    /// @dev Oracle contract should be done with respect to reference
<span class="fstat-no" title="function not covered" >    function changeOracle(IAToken _aToken, IOracle _oracle) external override onlyRole(GUARDIAN_ROLE) isValid(_aToken) {</span>
<span class="cstat-no" title="statement not covered" >        require((address(_oracle) != address(0)), "BondingCurve::changeOracle: oracle required")</span>;
<span class="cstat-no" title="statement not covered" >        allowedStablecoins[_aToken] = _oracle</span>;
<span class="cstat-no" title="statement not covered" >        emit ModifiedStablecoin(address(_aToken), referenceCoin == address(_aToken), address(_oracle));</span>
    }
&nbsp;
    /// @notice Revokes a stablecoin as a medium of payment
    /// @param _aToken Reference to the aToken
<span class="fstat-no" title="function not covered" >    function revokeStablecoin(IAToken _aToken) external onlyRole(GUARDIAN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        if (referenceCoin == address(_aToken)) {</span>
<span class="cstat-no" title="statement not covered" >            referenceCoin = address(0)</span>;
        }
        delete allowedStablecoins[_aToken];
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit RevokedStablecoin(address(_aToken));</span>
    }
&nbsp;
    /// @notice Changes the start price (in reference)
    /// @param _startPrice New start price for the formula
<span class="fstat-no" title="function not covered" >    function changeStartPrice(uint256 _startPrice) external onlyRole(GUARDIAN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        require(_startPrice &gt; 0, "BondingCurve::changeStartPrice: incorrect start price")</span>;
<span class="cstat-no" title="statement not covered" >        startPrice = _startPrice</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit StartPriceUpdate(_startPrice);</span>
    }
&nbsp;
    /// @notice Changes the total of tokens that can be sold with this bonding curve
    /// @param _totalTokensToSell New total amount of tokens to sell
<span class="fstat-no" title="function not covered" >    function changeTokensToSell(uint256 _totalTokensToSell) external onlyRole(GUARDIAN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _changeTokensToSell(_totalTokensToSell)</span>;
    }
&nbsp;
    /// @notice Pauses the possibility to buy soldToken from the contract
<span class="fstat-no" title="function not covered" >    function pause() external onlyRole(GUARDIAN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _pause()</span>;
    }
&nbsp;
    /// @notice Unpauses and reactivates the possibility to buy tokens from the contract
<span class="fstat-no" title="function not covered" >    function unpause() external onlyRole(GUARDIAN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _unpause()</span>;
    }
&nbsp;
    // ============================ Internal ===================================
&nbsp;
    /// @notice Internal version of the functions that changes the total tokens to sell
    /// @dev This function checks if the new amount of tokens to sell is compatible with what has already been sold
    /// @dev It can be used to decrease or increase what has already been sold
<span class="fstat-no" title="function not covered" >    function _changeTokensToSell(uint256 _totalTokensToSell) internal {</span>
<span class="cstat-no" title="statement not covered" >        require(_totalTokensToSell &gt; tokensSold, "BondingCurve::changeTokensToSell: incorrect amount")</span>;
<span class="cstat-no" title="statement not covered" >        require(</span>
            soldToken.balanceOf(address(this)) &gt;= _totalTokensToSell - tokensSold,
            "BondingCurve::changeTokensToSell: incorrect soldToken balance"
        );
<span class="cstat-no" title="statement not covered" >        totalTokensToSell = _totalTokensToSell</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit TokensToSellUpdate(_totalTokensToSell);</span>
    }
&nbsp;
    /// @notice Internal version of getQuantityLeftToSell
<span class="fstat-no" title="function not covered" >    function _getQuantityLeftToSell() internal view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return totalTokensToSell - tokensSold;</span>
    }
&nbsp;
    /// @notice Internal version of buyAtTargetQuantity
<span class="fstat-no" title="function not covered" >    function _computePriceFromQuantity(uint256 targetQuantity) internal view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            targetQuantity &lt;= _getQuantityLeftToSell(),
            "BondingCurve::_computePriceFromQuantity: not enough token left to sell"
        );
&nbsp;
        // The formula to compute the amount to pay is the integral of the price over the bounds:
        // tokensSold, tokensSold+targetQuantity.
        // The integral is that of the inverse of a square root, hence the formula below
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 toSellLessSoldPowered = (totalTokensToSell - tokensSold)**(power - 1);</span>
<span class="cstat-no" title="statement not covered" >        uint256 toSellLessNewSoldPowered = (totalTokensToSell - tokensSold - targetQuantity)**(power - 1);</span>
<span class="cstat-no" title="statement not covered" >        uint256 numerator = startPrice * totalTokensToSell**power * (toSellLessSoldPowered - toSellLessNewSoldPowered);</span>
<span class="cstat-no" title="statement not covered" >        uint256 denominator = power * BASE * toSellLessSoldPowered * toSellLessNewSoldPowered;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        return numerator / denominator;</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jun 29 2021 15:19:04 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
